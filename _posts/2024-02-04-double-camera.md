---
layout: post
title:  "カメラ付きプラレールの通信プロトコルを解析した話"
---

先日押し入れを整理していたところ、カメラの付いたドクターイエローのプラレールを発掘しました。

（ドクターイエローの写真）

こちらは[スマホで運転！ダブルカメラドクターイエロー](https://www.takaratomy.co.jp/products/plarail/tettei/set/16_09_pte/index.htm)という商品で、
名前の通りカメラが付いていてスマートホンから操作できるプラレールの電車です。
2016年10月にタカラトミーより発売されました。

私の手元にあるものは風穴さん ([@windhole](https://twitter.com/windhole)) から頂いたものでした。
私がプラレールで半加算器や全加算器を作っていた頃に面白いものがあるからと贈っていただいた記憶があります。

さて、昔のことを思い出しながらiPadに入っていた専用アプリで久々に遊んでみます。
アプリから電車の速度を変えられたり、車両に付いているカメラの映像を表示できたりとなかなか高機能でよくできたおもちゃです。
カメラはリアルタイムで先頭車両・車窓の2つが切り替えられるようになっていて凝った作りになっています。

（アプリの写真）

しかし残念ながらアプリの配信自体はすでに2022年までで終了しており、
中古などで手に入れた人はもう遊べないという状況になっていました。
そこで制御プロトコルを解析して、専用アプリ以外からもこのドクターイエローを制御できないか？と思い試すことにしました。

本記事ではその記録と得られた結果、および試行錯誤に使ったツールや情報をまとめます。

## 仕組み
最初に、専用アプリからどうやってドクターイエローに繋げるかを説明します。
とはいっても難しいことはなくて、ドクターイエローがWi-Fiの母艦になっており、
スマホなどの端末からそこに接続することで専用アプリとドクターイエローの通信ができる、という仕組みになっています。

（システム構成図みたいなのを出す）

というわけで、まずはWi-Fiの通信を傍受すれば、制御プロトコルがわかるのではないか？と考えて先に進むことにしました。

## Macでのパケットキャプチャがうまくいかない？！
真っ先に思いつくことはWi-Fiのパケットキャプチャですよね。
Macではワイヤレス診断.app というアプリケーションの機能としてWi-Fiスニファがあるのでそれを利用することにしました。
これによって、Macが関わらない部屋の中に飛んでいるWi-Fiの通信を傍受できます。
まず、前もってプラレールのWi-FiにMacから接続し、情報を確かめてみます。

（画像、Wi-Fiのやつ）

モバイル端末からだけではなく、Macからも接続できました。どうやら2.4GHz帯のチャネル1、チャネル幅は20MHzのようです。
この情報を元にWi-Fiスニファを使用します。
ワイヤレス診断.appのウィンドウ > スニファを選択するとチャネルとチャネル幅を選ぶダイアログが表示されるので、入力しスニファを実行します。
（その間、MacのWi-Fi機能は使えなくなります）

結果は `/var/tmp` ディレクトリに保存されるのですが...... なんとサイズが0バイトとなり、中身がありませんでした。
試しにチャネル2に対してスニファを実行したらうまく保存できたので、何らかの制約があるのかもしれません。
（ご存知の方がいらっしゃったら教えていただけると嬉しいです）

Linuxなどの別の端末で行うことも考えましたが、やや大変そうだったためパケットの空気録音はあきらめることにしました。

## Macで接続した際の挙動
MacからドクターイエローのWi-Fiに繋いだ際には、DHCPが有効になっており、降ってきたIPアドレスは `192.168.123.2` で、ゲートウェイは `192.168.123.1` でした。
試しにこのIPアドレスに対して ping を飛ばしたところ予想通り返ってきました。
複雑なことをしているとも思えないので `192.168.123.1` に何かしらを行えばドクターイエローの制御ができると思われます。

次にやることといったらポートスキャンでしょうか。
開いているTCPポートを探すことにしました。
`nmap` コマンドを試してみましたが、反応はなかったので次はどうしようかという感じになりました。

## 専用アプリを騙す：ルーターの設定でMacのIPアドレスをプラレールのものと同じにする
今回捕捉したい通信は専用アプリからドクターイエローへの命令なのですが、
Wi-Fiのスニッフィングがうまくいかないことから別の手段を講じる必要がありました。
少々考えたところ、 **MacのIPアドレスを 192.168.123.1 にして** 同じネットワークに接続すればアプリから繋ぎに来てくれるのではと予想しました。

（ルーター越しに繋がっている図）

自宅で使っているのがTP-Link普通のルーターでしたが、DHCPのアドレス予約機能を使うことでMacのMACアドレスに対して 192.168.123.1 を割り当てることができました。
その際に、サブネットマスクを 255.255.255.0 から 255.255.0.0 に変更する必要がありました。

この状況でWiresharkでパケットキャプチャを開始し、アプリでの操作を行うと... 出ました、
192.168.123.1 への**UDP**の通信です。

（スキャン結果）

UDPとは盲点でした。ポートスキャンがうまくいかなかったのも合点が行きます。
パケットキャプチャ中にいろいろな操作をしたところ、
専用アプリは以下の表のような体系でコマンドを送信することが分かりました。

| 操作                   | UDP宛先ポート | ペイロード | ASCII表現 | 備考 |
| --------------------  | ---- | --------- |--- | - |
| 接続確認・設定の取得     | 30863 | `0x42 0x02` | B\x02 | SSID・MACアドレス等 <br> を含むレスポンスが返ってくる |
| 映像配信要求            | 30863 | `0x42 0x76` | Bv | 詳しくは後述 |
| 映像停止要求？          | 30863 | `0x42 0x76` | Bw | あまり確証がない |
| カメラを車窓に切り替え    | 30864 | `0x42 0x70` | Bp | |
| カメラを運転席に切り替え  | 30864 | `0x42 0x71` | Bq | |
| 高速で走行              | 30864 | `0x42 0x72` | Br | |
| バック走行              | 30864 | `0x42 0x73` | Bs | | 
| 低速で走行              | 30864 | `0x42 0x74` | Bt | |
| 電車を停止              | 30864 | `0x42 0x75` | Bu | |

ひとつ何か実行してみましょう。UDPパケットを送る方法はncコマンドなどいくつかありますが、
一番手軽だと筆者が考えるは bash の擬似デバイスを使う方法です。
では電車を走らせるコマンドを送ってみます、動くでしょうか...

```bash
printf 'Bt' > /dev/udp/192.168.123.1/30864
```

（コマンドを打って電車が走るGIF）

やりました、成功です！
次の課題は映像の取得です。

## 映像は謎
カメラが2つもついてるのに肝心の映像が見れないとなったら寂しいです。
ここからはどうにかしてドクターイエローからの映像を取得して表示できないか調査していきました。

パケットキャプチャの結果から、ポート30863番に `0x42 0x76` を送ると
ドクターイエローはポート30865番に映像データを送り始めることは分かっていましたが、肝心の中身はさっぱり分かりません。
ただ、わからないなりにパケットを観察すると以下のような規則性が読み取れました。

- パケットは固定長で1028バイト
- パケットの末尾4バイトには規則性があった。これをマーカーと呼びます。
- マーカーの後ろ2バイトはパケット間で連番になっており、短い周期でリセットされる
  - 周期や送信時刻を見るに、この数字は映像の1フレーム中のパケット番号を表しているのではないかと推測
- マーカーの先頭2バイトは以下のパターンになっていた
    - `0xFF 0xDA` ... フレームの最初のパケット。つまりパケット番号は常に0
    - `0xFF 0xDD` ... フレームの中間のパケット
    - `0x06 0xD9` ... フレームの最後のパケット
- 1フレームあたりのパケット数は可変だった。

マーカーを除くとパケット1つの長さが1024バイト（2の10乗）というキリのいい数字であることから、
データ全体を1024バイトずつに分割したあとマーカーを付与し、固定長のUDPパケットとして送信していると推測しました。
そのため、1フレームあたりの映像データはパケットの内容を結合したものだと仮定して進めることにしました。

### 真っ黒な映像をキャプチャしてみる
私自身、映像のコーデックに関する知識は人並みにしかありません。
そんな時に規則性を見つけるには、システムに対して極端な入力を与えた時の挙動を見ることが手掛かりになることが多いです。
極端な入力として唯一思いついたのが、カメラを手で覆って真っ黒な映像のパケットをキャプチャすることでした。
するとこんな感じのパケットがやってきました。

（Wiresharkでキャプチャしたやつ）

最初のパケットは `e5` から始まり `28 a0 02 8a 00` を繰り返しています。
続くパケットもこのパターンを繰り返しており、全体で1200回繰り返していました。

（それっぽい16進数の図）

また、各フレームに対しては全く同じデータを含むパケット群がやってきました。
つまり、1フレーム目も2フレーム目もその先も、上の図に描いたようなデータがドクターイエローからやってきました。

さて、ここに来て興味深い規則性を見つけることができました。
これをきっかけに映像プロトコルの解析は大きく進むことになります。

### Motion JPEGという説
この話を会社でしたところ、後輩のぱくとまさん ([@pakutoma](https://twitter.com/pakutoma)) から、
カメラモジュールはMotion JPEGで出力することが多いという話を聞きました。
なるほど、Motion JPEG。調べたところ各フレームをJPEGファイル形式で保存するフォーマットのようです。
また、それぞれのフレームが独立してエンコードされるという特徴があるようでした。

MPEG-4などの他のコーデックはフレーム間予測などを用いることから、フレーム間にデータの依存関係があることが考えられるため、
キャプチャした別々のフレームのデータが全く同じになるということはやはりMotion JPEGなのではないか？という目星がつきました。

### パターンでググる
次にやることは何でしょうか？数少ない手掛かりであるところの "28 a0 02 8a 00" でとりあえずググってみました。
完全一致を使うために引用符で囲って検索したところ、次のようなページがヒットしました。

- https://gist.github.com/tomvdb/3770f3385faaa3220c7d5d2aadee13ae
- https://gstreamer-bugs.narkive.com/dysVZeiz/bug-763745-new-can-not-decode-jpeg-without-huffman-tables

どちらもJPEGファイルのダンプを掲載したページのようです。
これによってドクターイエローからの映像がJPEG形式で圧縮されているという確証がかなり高まりました。
ここから先はデータがJPEG圧縮されていると仮定して進めていきました。


## JPEGファイルの構造
映像データ復元のため、JPEGファイルのフォーマットについて調査しました。

JPEGファイルのデコードには色空間の変換や離散コサイン変換などたくさんの工程が関わります。
その中でも、量子化（の復元）およびハフマン符号のデコードには画像データそのものの他に、
それぞれの処理のために量子化テーブルおよびハフマンテーブルが必要となります。

こういったテーブルは画像ファイル内では共通ですが、画像ごとに異なるものが通常は使われます。
そのため、ファイル内の画像データとは別の領域に格納する必要があります。

（すっごい雑なJPEGのフォーマットの説明）

また、JPEGファイルは先頭・末尾のマーカー、画像データ、そしていくつかの*セグメント*から構成されます。
マーカーは固定のバイト列、画像データはさまざまな工程を経てエンコードされたデータ、そしてセグメントは以下のような情報を定義するものが含まれます

- 量子化テーブル (DQT)
- ハフマンテーブル (DHT)
- フレームヘッダー (SOF)
  - 画像の大きさなど、JPEGファイルを構成するのに必要な情報を持つ
- スキャンヘッダー (SOS)
  - 画像データの開始を表し、これより後に続く画像データに必要な情報を持つ

他にもアプリケーションデータの保存に使われるセグメントや、
注釈（コメント）を保存するためのセグメントなどがありますが、
今回の登場人物は上の4種類のセグメントです。

さて、この知識を踏まえて


その後、最後のパケットにて `0xFF 0x09` でパターンが終了した後はまたパターンが繰り返されています。


- やはりJPEGか？フレームの最後に EOI があるぞ


## テーブルがパケットのどこにも見当たらない
- 試しに規格で定義されたテーブルを使ってみるも、うまくデコードはできない

## 録画をダンプする
- 